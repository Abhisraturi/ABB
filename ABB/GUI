import tkinter as tk
from tkinter import messagebox
import pyodbc
from datetime import datetime

# --- SQL CONFIG ---
SQL_SERVER = "DESKTOP-F4FK4GN"
SQL_DB = "DATA"
TABLE = "Cylinder_detail_Cal_1"
conn_str = (
    f"DRIVER={{SQL Server}};"
    f"SERVER={SQL_SERVER};"
    f"DATABASE={SQL_DB};"
    f"Trusted_Connection=yes;"
)

# Calibration types to show (must exist in the table)
calibrations = [
    "Zero calibration",
    "N2O calibration",
    "NO calibration",
    "N2O Mid calibration"
]

# GUI
root = tk.Tk()
root.title("Cylinder Calibration Editor")

entries = {}

# Header
tk.Label(root, text="Calibration", font=('Arial', 12, 'bold')).grid(row=0, column=0, padx=10, pady=5)
tk.Label(root, text="Cylinder Number", font=('Arial', 12, 'bold')).grid(row=0, column=1, padx=10, pady=5)
tk.Label(root, text="Date (YYYY-MM-DD)", font=('Arial', 12, 'bold')).grid(row=0, column=2, padx=10, pady=5)

# Connect and fetch initial data
def load_data():
    try:
        conn = pyodbc.connect(conn_str)
        cursor = conn.cursor()

        for i, calib in enumerate(calibrations, start=1):
            cursor.execute(f"""
                SELECT Cylinder_Number, Date FROM {TABLE}
                WHERE Calibration = ?
            """, calib)

            row = cursor.fetchone()

            cyl_val = row.Cylinder_Number if row else ""
            date_val = row.Date.strftime("%Y-%m-%d") if row and row.Date else ""

            tk.Label(root, text=calib).grid(row=i, column=0, padx=10, pady=5, sticky='w')

            cyl_entry = tk.Entry(root)
            cyl_entry.insert(0, cyl_val)

            date_entry = tk.Entry(root)
            date_entry.insert(0, date_val)

            cyl_entry.grid(row=i, column=1, padx=10, pady=5)
            date_entry.grid(row=i, column=2, padx=10, pady=5)

            entries[calib] = {
                "cyl": cyl_entry,
                "date": date_entry,
                "original_cyl": cyl_val,
                "original_date": date_val
            }

        conn.close()
    except Exception as e:
        messagebox.showerror("DB Load Error", str(e))

# Update only changed rows
def update_database():
    try:
        conn = pyodbc.connect(conn_str)
        cursor = conn.cursor()
        updates = 0

        for calib, fields in entries.items():
            new_cyl = fields["cyl"].get().strip()
            new_date = fields["date"].get().strip()
            orig_cyl = fields["original_cyl"]
            orig_date = fields["original_date"]

            if new_cyl == "" or new_date == "":
                continue

            # Check if changes made
            if new_cyl != orig_cyl or new_date != orig_date:
                try:
                    # Validate date
                    datetime.strptime(new_date, '%Y-%m-%d')
                except ValueError:
                    messagebox.showerror("Invalid Date", f"Invalid date format for '{calib}'")
                    return

                cursor.execute(f"""
                    UPDATE {TABLE}
                    SET Cylinder_Number = ?, Date = ?
                    WHERE Calibration = ?
                """, new_cyl, new_date, calib)
                updates += 1

        conn.commit()
        conn.close()

        messagebox.showinfo("Success", f"{updates} record(s) updated successfully!")

    except Exception as e:
        messagebox.showerror("Update Error", str(e))

# Buttons
tk.Button(root, text="Update Records", command=update_database, bg="green", fg="white").grid(row=len(calibrations)+1, column=1, pady=15)

# Load existing data
load_data()

root.mainloop()
